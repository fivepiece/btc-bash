#!/bin/bash

hc_16to2()
{
    local OIFS="$IFS"
    local -u b2="${1}"
    #read b2 < <( revbytes "${b2}" 2 )
    read b2 < <( BC_ENV_ARGS="-q" bc <<<"obase=2; ibase=16; ${b2}" ) # | rev
    IFS='%'
    read b2 < <( printf "%0${2}s%s\n" ${b2} )
    #read b2 < <( printf "%s%0$(( ${2}-${#b2} ))s\n" ${b2} )
    if (( ${#b2} > ${2} )); then
        echo "hc_16to2() value too large"
        return 1
    fi
    echo "${b2//$' '/0}" #| rev
    IFS="$OIFS"
}

hc_2to16()
{
    local OIFS="$IFS"
    IFS='%'
    local b2="${1}"
    #read b2 < <( echo "${b2}" | rev )
    #read b2 < <( revbytes "${b2}" 1 )
    read b2 < <( BC_ENV_ARGS="-q" bc <<<"obase=16; ibase=2; ${b2}" )
    read b2 < <( printf "%0${2}s%s\n" ${b2} )
    #read b2 < <( printf "%s%0$(( ${2}-${#b2} ))s\n" ${b2} )
    echo "${b2//$' '/0}" 
    IFS="$OIFS"
}

hc_flip()
{
    if [[ "${1}" == 1 ]]; then
        echo 0
    else
        echo 1
    fi
}

hc_flip_bit_in_value()
{
    local value="${1}"
    local -i i="${2}" bit
    read bit < <( hc_flip "${value:$i:1}" )
    
    echo -e "${value:0:$i}${bit}${value:$((i+1))}"
}

hc_count_trailing_zeros()
{
    local -u val="${1}"
    read val < <( hc_16to2 "${val}" 64 )
    val="${val//*1}"
    echo "${#val}"
}

# sender's tree

hc_generate_from_seed()
{
    local -u value="${1}" index="${2}"
    read value < <( revbytes "${1}" 2 )
    read value < <( hc_16to2 "${value}" 256 )
    read index < <( hc_16to2 "${index}" 48 )

    decho "value : ${value}"
    decho "index : ${index}"
    decho "----------------------------------------------------------------\n"
    for (( i=0, j=0, k=$((256-48)); i<49; i++, j++, k++ )); do

        if [[ "${index:${j}:1}" == 1 ]]; then
            
            decho "value : ${value:0:$k}\e[31m${value:$k:1}\e[0m${value:$((k+1))}"
            decho "index : ${index:0:$j}\e[31m${index:$j:1}\e[0m${index:$((j+1))}"
            decho "bit   : ${j}"
            read bit < <( hc_flip "${value:$k:1}" )
            decho "flip  : ${value:0:$k}\e[31m${bit}\e[0m${value:$((k+1))}"
            #read value < <( echo "${value:0:$k}${bit}${value:$((k+1))}" )
            value="${value:0:$k}${bit}${value:$((k+1))}"
            read value < <( hc_2to16 "${value}" 64 )
            read value < <( revbytes "${value}" 2 )
            decho "pre h : ${value}"
            read value < <( sha256 "${value}" )
            decho "hash  : ${value}"
            read value < <( revbytes "${value}" 2 )
            read value < <( hc_16to2 "${value}" 256 )
        fi
    done

    decho "\nfinal 2  : \n${value}\nfinal 16 : "
    read value < <( hc_2to16 "${value}" "64" )
    revbytes "${value}" 2 ; echo
}

# receiver's tree

hc_can_derive()
{
    local -u from_index="${1}" to_index="${2}"
    local -i i
    read from_index < <( hc_16to2 "${from_index}" 64 )
    read to_index < <( hc_16to2 "${to_index}" 64 )
    read i < <( hc_count_trailing_zeros "${1}" )

    for (( i; i<64; i++ )); do

        if [[ "${from_index:$i:1}" == 1 ]] && [[ ! "${to_index:$i:1}" != 1 ]]; then
            echo false && return 1
        fi
    done

    echo true && return 0
}

hc_derive()
{
    local -u from_index="${1}" to_index="${2}" from_value="${3}" value

    if ! hc_can_derive "${from_index}" "${to_index}"; then
        echo "hc_can_derive() assert failed"
        return 1
    fi

    read from_index < <( hc_16to2 "${from_index}" 64 )
    read to_index < <( hc_16to2 "${to_index}" 64 )
    read value < <( hc_16to2 "${from_value}" 256 )
    for (( i=0; i<64; i++ )); do

        if (( ${from_index:$i:1} )) && (( ! ${to_index:$i:1} )); then

            read value < <( hc_flip_bit_in_value "${value}" "${i}" )
            read value < <( hc_2to16 "${value}" 64 )
            read value < <( sha256 "${value}" )
            read value < <( hc_16to2 "${value}" 256 )
        fi
    done

    hc_2to16 ${value} 64
}

hc_receive_value()
{
    local -u index="${1}" value="${2}"
    local -i pos
    read pos < <( hc_count_trailing_zeros "${index}" )

    for (( i=0; i<${pos}; i++ )); do

        # derive "${
        false
    done
    return true
}

hc_regenerate_value()
{
    echo failed
}

hc_test()
{
    # test base convert

    local one="1" \
        one48="000000000000000000000000000000000000000000000001" \
        one256="0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001"

    local -a t16to2_48 t16to2_256
    t16to2_48[0]=000000000000000000000000000000000000000000000000
    t16to2_48[1]=000000000000000000000000000000000000000000000001
    t16to2_48[2]=000000000000000000000000000000000000000000000010
    t16to2_48[3]=000000000000000000000000000000000000000000000011
    t16to2_48[4]=000000000000000000000000000000000000000000000100
    t16to2_48[5]=000000000000000000000000000000000000000000000101
    t16to2_48[6]=000000000000000000000000000000000000000000000110
    t16to2_48[7]=000000000000000000000000000000000000000000000111
    t16to2_48[8]=000000000000000000000000000000000000000000001000
    t16to2_48[9]=000000000000000000000000000000000000000000001001
    t16to2_48[10]=000000000000000000000000000000000000000000001010
    t16to2_48[11]=000000000000000000000000000000000000000000001011
    t16to2_48[12]=000000000000000000000000000000000000000000001100
    t16to2_48[13]=000000000000000000000000000000000000000000001101
    t16to2_48[14]=000000000000000000000000000000000000000000001110
    t16to2_48[15]=000000000000000000000000000000000000000000001111
    t16to2_48[16]=000000000000000000000000000000000000000000010000
    t16to2_48[1108152157438]=000000010000001000000011000001000000010011111110
    t16to2_48[1108152157439]=000000010000001000000011000001000000010011111111
    t16to2_48[1108152157440]=000000010000001000000011000001000000010100000000
    t16to2_48[1108152157441]=000000010000001000000011000001000000010100000001
    t16to2_48[1108152157442]=000000010000001000000011000001000000010100000010
    t16to2_48[1108152157443]=000000010000001000000011000001000000010100000011
    t16to2_48[1108152157444]=000000010000001000000011000001000000010100000100
    t16to2_48[1108152157445]=000000010000001000000011000001000000010100000101
    t16to2_48[1108152157446]=000000010000001000000011000001000000010100000110
    t16to2_48[1108152157447]=000000010000001000000011000001000000010100000111
    t16to2_48[1108152157448]=000000010000001000000011000001000000010100001000
    t16to2_48[1108152157449]=000000010000001000000011000001000000010100001001
    t16to2_48[1108152157450]=000000010000001000000011000001000000010100001010
    t16to2_48[1108152157451]=000000010000001000000011000001000000010100001011
    t16to2_48[1108152157452]=000000010000001000000011000001000000010100001100
    t16to2_48[1108152157453]=000000010000001000000011000001000000010100001101
    t16to2_48[1108152157454]=000000010000001000000011000001000000010100001110
    t16to2_48[6618611909113]=000001100000010100000100000000110000000111111001
    t16to2_48[6618611909114]=000001100000010100000100000000110000000111111010
    t16to2_48[6618611909115]=000001100000010100000100000000110000000111111011
    t16to2_48[6618611909116]=000001100000010100000100000000110000000111111100
    t16to2_48[6618611909117]=000001100000010100000100000000110000000111111101
    t16to2_48[6618611909118]=000001100000010100000100000000110000000111111110
    t16to2_48[6618611909119]=000001100000010100000100000000110000000111111111
    t16to2_48[6618611909120]=000001100000010100000100000000110000001000000000
    t16to2_48[6618611909121]=000001100000010100000100000000110000001000000001
    t16to2_48[6618611909122]=000001100000010100000100000000110000001000000010
    t16to2_48[6618611909123]=000001100000010100000100000000110000001000000011
    t16to2_48[6618611909124]=000001100000010100000100000000110000001000000100
    t16to2_48[6618611909125]=000001100000010100000100000000110000001000000101
    t16to2_48[6618611909126]=000001100000010100000100000000110000001000000110
    t16to2_48[6618611909127]=000001100000010100000100000000110000001000000111
    t16to2_48[6618611909128]=000001100000010100000100000000110000001000001000
    t16to2_48[6618611909129]=000001100000010100000100000000110000001000001001
    t16to2_48[11728124029602]=000010101010101010101010101010101010101010100010
    t16to2_48[11728124029603]=000010101010101010101010101010101010101010100011
    t16to2_48[11728124029604]=000010101010101010101010101010101010101010100100
    t16to2_48[11728124029605]=000010101010101010101010101010101010101010100101
    t16to2_48[11728124029606]=000010101010101010101010101010101010101010100110
    t16to2_48[11728124029607]=000010101010101010101010101010101010101010100111
    t16to2_48[11728124029608]=000010101010101010101010101010101010101010101000
    t16to2_48[11728124029609]=000010101010101010101010101010101010101010101001
    t16to2_48[11728124029610]=000010101010101010101010101010101010101010101010
    t16to2_48[11728124029611]=000010101010101010101010101010101010101010101011
    t16to2_48[11728124029612]=000010101010101010101010101010101010101010101100
    t16to2_48[11728124029613]=000010101010101010101010101010101010101010101101
    t16to2_48[11728124029614]=000010101010101010101010101010101010101010101110
    t16to2_48[11728124029615]=000010101010101010101010101010101010101010101111
    t16to2_48[11728124029616]=000010101010101010101010101010101010101010110000
    t16to2_48[11728124029617]=000010101010101010101010101010101010101010110001
    t16to2_48[11728124029618]=000010101010101010101010101010101010101010110010
    t16to2_48[17730434519128]=000100000010000000110000010000000101000001011000
    t16to2_48[17730434519129]=000100000010000000110000010000000101000001011001
    t16to2_48[17730434519130]=000100000010000000110000010000000101000001011010
    t16to2_48[17730434519131]=000100000010000000110000010000000101000001011011
    t16to2_48[17730434519132]=000100000010000000110000010000000101000001011100
    t16to2_48[17730434519133]=000100000010000000110000010000000101000001011101
    t16to2_48[17730434519134]=000100000010000000110000010000000101000001011110
    t16to2_48[17730434519135]=000100000010000000110000010000000101000001011111
    t16to2_48[17730434519136]=000100000010000000110000010000000101000001100000
    t16to2_48[17730434519137]=000100000010000000110000010000000101000001100001
    t16to2_48[17730434519138]=000100000010000000110000010000000101000001100010
    t16to2_48[17730434519139]=000100000010000000110000010000000101000001100011
    t16to2_48[17730434519140]=000100000010000000110000010000000101000001100100
    t16to2_48[17730434519141]=000100000010000000110000010000000101000001100101
    t16to2_48[17730434519142]=000100000010000000110000010000000101000001100110
    t16to2_48[17730434519143]=000100000010000000110000010000000101000001100111
    t16to2_48[17730434519144]=000100000010000000110000010000000101000001101000
    t16to2_48[93824992236877]=010101010101010101010101010101010101010101001101
    t16to2_48[93824992236878]=010101010101010101010101010101010101010101001110
    t16to2_48[93824992236879]=010101010101010101010101010101010101010101001111
    t16to2_48[93824992236880]=010101010101010101010101010101010101010101010000
    t16to2_48[93824992236881]=010101010101010101010101010101010101010101010001
    t16to2_48[93824992236882]=010101010101010101010101010101010101010101010010
    t16to2_48[93824992236883]=010101010101010101010101010101010101010101010011
    t16to2_48[93824992236884]=010101010101010101010101010101010101010101010100
    t16to2_48[93824992236885]=010101010101010101010101010101010101010101010101
    t16to2_48[93824992236886]=010101010101010101010101010101010101010101010110
    t16to2_48[93824992236887]=010101010101010101010101010101010101010101010111
    t16to2_48[93824992236888]=010101010101010101010101010101010101010101011000
    t16to2_48[93824992236889]=010101010101010101010101010101010101010101011001
    t16to2_48[93824992236890]=010101010101010101010101010101010101010101011010
    t16to2_48[93824992236891]=010101010101010101010101010101010101010101011011
    t16to2_48[93824992236892]=010101010101010101010101010101010101010101011100
    t16to2_48[93824992236893]=010101010101010101010101010101010101010101011101
    t16to2_48[105897790545928]=011000000101000001000000001100000010000000001000
    t16to2_48[105897790545929]=011000000101000001000000001100000010000000001001
    t16to2_48[105897790545930]=011000000101000001000000001100000010000000001010
    t16to2_48[105897790545931]=011000000101000001000000001100000010000000001011
    t16to2_48[105897790545932]=011000000101000001000000001100000010000000001100
    t16to2_48[105897790545933]=011000000101000001000000001100000010000000001101
    t16to2_48[105897790545934]=011000000101000001000000001100000010000000001110
    t16to2_48[105897790545935]=011000000101000001000000001100000010000000001111
    t16to2_48[105897790545936]=011000000101000001000000001100000010000000010000
    t16to2_48[105897790545937]=011000000101000001000000001100000010000000010001
    t16to2_48[105897790545938]=011000000101000001000000001100000010000000010010
    t16to2_48[105897790545939]=011000000101000001000000001100000010000000010011
    t16to2_48[105897790545940]=011000000101000001000000001100000010000000010100
    t16to2_48[105897790545941]=011000000101000001000000001100000010000000010101
    t16to2_48[105897790545942]=011000000101000001000000001100000010000000010110
    t16to2_48[105897790545943]=011000000101000001000000001100000010000000010111
    t16to2_48[105897790545944]=011000000101000001000000001100000010000000011000
    t16to2_48[281474976710639]=111111111111111111111111111111111111111111101111
    t16to2_48[281474976710640]=111111111111111111111111111111111111111111110000
    t16to2_48[281474976710641]=111111111111111111111111111111111111111111110001
    t16to2_48[281474976710642]=111111111111111111111111111111111111111111110010
    t16to2_48[281474976710643]=111111111111111111111111111111111111111111110011
    t16to2_48[281474976710644]=111111111111111111111111111111111111111111110100
    t16to2_48[281474976710645]=111111111111111111111111111111111111111111110101
    t16to2_48[281474976710646]=111111111111111111111111111111111111111111110110
    t16to2_48[281474976710647]=111111111111111111111111111111111111111111110111
    t16to2_48[281474976710648]=111111111111111111111111111111111111111111111000
    t16to2_48[281474976710649]=111111111111111111111111111111111111111111111001
    t16to2_48[281474976710650]=111111111111111111111111111111111111111111111010
    t16to2_48[281474976710651]=111111111111111111111111111111111111111111111011
    t16to2_48[281474976710652]=111111111111111111111111111111111111111111111100
    t16to2_48[281474976710653]=111111111111111111111111111111111111111111111101
    t16to2_48[281474976710654]=111111111111111111111111111111111111111111111110
    t16to2_48[281474976710655]=111111111111111111111111111111111111111111111111

    local tone48 tone256
    read tone48 < <( hc_16to2 ${one} 48 )
    read tone256 < <( hc_16to2 ${one} 256 )
    [[ ${tone48} == ${one48} ]] && [[ ${tone256} == ${one256} ]] || echo "hc_16to2 failed" && return 1

}
